<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>用extroot为openwrt扩充存储空间</title>
        <link rel="stylesheet" href="./theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">Solarck  <strong>金融民工与程序猿的结合体</strong></a></h1>
                <nav><ul>
                    <li class="active"><a href="./category/itbi-ji.html">IT笔记</a></li>
                    <li><a href="./category/jin-rong-bi-ji.html">金融笔记</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./openwrt-extroot.html" rel="bookmark"
           title="Permalink to 用extroot为openwrt扩充存储空间">用extroot为openwrt扩充存储空间</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-01-03T01:48:00+08:00">
                发布时间: 一月 03, 2014
        </abbr>

        <address class="vcard author">
                作者:                         <a class="url fn" href="./author/kevin-chen.html">Kevin Chen</a>
        </address>
<p>分类: <a href="./category/itbi-ji.html">IT笔记</a></p>
<p>标签: <a href="./tag/openwrt.html">openwrt</a> </p>
</footer><!-- /.post-info -->      <p>水星这款MW4350r内存为128M，运行很多程序都不在话下。但是却只提供了8M&nbsp;Flash存储空间，而路由器系统还占了1.9M，剩下的5M空间不足以支持安装很多软件，比如我在安装python的时候就报错提示存储空间不足，这确实很郁闷，但幸好Openwrt还提供了extroot方式来扩展存储，来发挥路由器和Openwrt系统的真正实力。</p>
<p><strong>pivot-overlay还是pivot-root？</strong></p>
<blockquote>
<p>我把两种方式都试过，pivot-overlay方式不能够把安装程序的位置移到USB存储装置上，但是pivot-root方式可以，所以我选择了后者。pivot-root方式使/覆盖掉了/overlay成为rootfs，我认为这种方式更接近原生的Linux系统。  <br>
而从官方的文档来看，目前pivot-root已经没有以前的缺点和不足，选择哪个已经是个人需求而不是技术问题了。  <br>
网上大部分文章帖子都是2009-2010年间的，所以大部分可能都是pivot-overlay的。如果对这部分不太理解，请仔细阅读官方Wiki：<a href="http://wiki.openwrt.org/doc/howto/extroot/extroot.theory">ExtRoot: How it works</a>,<a href="http://wiki.openwrt.org/doc/techref/flash.layout">The OpenWrt Flash&nbsp;Layout</a></p>
</blockquote>
<!--more-->

<h3>安装必要的包</h3>
<div class="highlight"><pre><span></span>opkg update
opkg install e2fsprogs kmod-usb-core kmod-usb2 kmod-usb-storage usbutils kmod-fs-ext4 block-mount
</pre></div>


<p>e2fsprogs包提供了mkfs（mkfs.ext3,mkfs.ext4）、fsck等工具。  <br>
kmod-usb2只提供了USb2.0的驱动，如果你的是USB1.0（1.1）的，还需要单独安装驱动。  <br>
kmod-fs-ext4是用来挂载ext4文件系统的，如果你想使用ext3文件格式就安装相应的包。  <br>&nbsp;usbutils不是必装，仅提供了lsusb命令。</p>
<h3>格式化U盘</h3>
<p>插好U盘后，先查看下是否被系统识别出来</p>
<div class="highlight"><pre><span></span>root@openwrt: ~# lsusb
Bus <span class="m">001</span> Device <span class="m">002</span>: ID <span class="m">0781</span>:5571 SanDisk Corp. Cruzer Fit
Bus <span class="m">001</span> Device <span class="m">001</span>: ID 1d6b:0002 Linux Foundation <span class="m">2</span>.0 root hub
</pre></div>


<div class="highlight"><pre><span></span>root@openwrt: ~# ls /dev/sd*
/dev/sda    /dev/sda1
</pre></div>


<p>已经正确识别出来了，格式化系统为ext4</p>
<div class="highlight"><pre><span></span>mkfs.ext4 /dev/sda1
</pre></div>


<p>挂载到当前系统</p>
<div class="highlight"><pre><span></span>mount /dev/sda1 /mnt
</pre></div>


<p>创建一个128M的swap文件</p>
<div class="highlight"><pre><span></span>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/mnt/swap <span class="nv">bs</span><span class="o">=</span><span class="m">2048</span> <span class="nv">count</span><span class="o">=</span><span class="m">65536</span>
mkswap /mnt/swap
swapon /mnt/swap
</pre></div>


<h3>extroot</h3>
<p>把/目录下的文件迁移到U盘,pivot-root方式，适用于Barrier&nbsp;Breaker（trunk）版本</p>
<div class="highlight"><pre><span></span>mkdir -p /tmp/cproot
mount --bind / /tmp/cproot
tar -C /tmp/cproot -cvf - . <span class="p">|</span> tar -C /mnt/ -xf -
umount /tmp/cproot
</pre></div>


<h3>编辑fstab</h3>
<p>我的系统默认没有/etc/config/fstab文件，可以用命令生成一个</p>
<div class="highlight"><pre><span></span>block detect &gt; /etc/config/fstab
</pre></div>


<p>编辑这个文件，添加下面这段配置</p>
<div class="highlight"><pre><span></span>config mount
        option target        /
        option device        /dev/sda1
        option fstype        ext4
        option options       rw,sync
        option enabled       <span class="m">1</span>
        option enabled_fsck  <span class="m">0</span>
</pre></div>


<p>重启后，查看下空间，如果类似我这样就是成功了</p>
<div class="highlight"><pre><span></span>root@openwrt: ~# df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    <span class="m">7</span>.2G    <span class="m">169</span>.9M      <span class="m">6</span>.7G   <span class="m">2</span>% /
/dev/root                 <span class="m">1</span>.8M      <span class="m">1</span>.8M         <span class="m">0</span> <span class="m">100</span>% /rom
tmpfs                    <span class="m">61</span>.7M      <span class="m">1</span>.0M     <span class="m">60</span>.7M   <span class="m">2</span>% /tmp
/dev/sda1                 <span class="m">7</span>.2G    <span class="m">169</span>.9M      <span class="m">6</span>.7G   <span class="m">2</span>% /
tmpfs                   <span class="m">512</span>.0K         <span class="m">0</span>    <span class="m">512</span>.0K   <span class="m">0</span>% /dev
</pre></div>


<p>大功告成，现在系统空间足够大了，任你怎么安装怎么下载。</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'solarck';
        var disqus_identifier = 'openwrt-extroot.html';
        var disqus_url = './openwrt-extroot.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//solarck.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>链接</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>社交网站</h2>
                        <ul>

                            <li><a href="https://github.com/princelai">Github</a></li>
                            <li><a href="https://plus.google.com/100073068742779779797">G+</a></li>
                            <li><a href="https://twitter.com/princelai">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->
        <!--
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address>

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer>-->
    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1337838-7', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'solarck';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>