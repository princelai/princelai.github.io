<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>VPS搭梯子指南——shadowsocks+BBR+obfs</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Solarck  <strong>金融民工与程序猿的结合体</strong></a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/itbi-ji.html">IT笔记</a></li>
                    <li><a href="/category/jin-rong-bi-ji.html">金融笔记</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/shadowsocks-libev.html" rel="bookmark"
           title="Permalink to VPS搭梯子指南——shadowsocks+BBR+obfs">VPS搭梯子指南——shadowsocks+<span class="caps">BBR</span>+obfs</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-11-13T15:55:00+08:00">
                发布时间: 十一月 13, 2017
        </abbr>
		<br />
        <abbr class="modified" title="2018-06-05T13:01:00+08:00">
                更新时间: 六月 05, 2018
        </abbr>

        <address class="vcard author">
                作者:                         <a class="url fn" href="/author/kevin-chen.html">Kevin Chen</a>
        </address>
<p>分类: <a href="/category/itbi-ji.html">IT笔记</a></p>
<p>标签: <a href="/tag/shadowsocks.html">shadowsocks</a> </p>
</footer><!-- /.post-info -->      <p>近期开会导致墙越来越高，迫不得已升级自建的ss服务，由于shadowsocks原版已经停更，shadowsocksR也已经删库，所以就锁定libev版本。
<strong><em>注：以下服务器端内容请切换到root操作</em></strong></p>
<h3>1.&nbsp;升级Debian</h3>
<p>在升级之前，我需要先把服务器从Debian 8升级到Debian&nbsp;9，如果不是Debian用户，或者不想升级的可以跳过，这一步不影响后续操作，但是部分代码可能需要修改。</p>
<p>首先要把Debian&nbsp;8升级到最新版本</p>
<div class="highlight"><pre><span></span>apt update
apt upgrade
</pre></div>


<p>备份源列表</p>
<div class="highlight"><pre><span></span>cp /etc/apt/sources.list /etc/apt/sources.list-jessie
</pre></div>


<p>修改源列表，把jessie 替换为&nbsp;stretch</p>
<div class="highlight"><pre><span></span>vim /etc/apt/sources.list
:s/jessie/stretch/g
</pre></div>


<p>再次更新升级</p>
<div class="highlight"><pre><span></span> apt update
 apt upgrade
 apt dist-upgrade
 apt autoremove
</pre></div>


<h3>2.&nbsp;开启BBR</h3>
<p>使用一键脚本安装并开启bbr，此步除OpenVZ以外的服务器都可以开启，跳过不影响后续内容。</p>
<div class="highlight"><pre><span></span>wget --no-check-certificate https://raw.githubusercontent.com/princelai/across/master/bbr.sh
chmod +x bbr.sh
./bbr.sh
echo &quot;net.core.default_qdisc=fq&quot; &gt;&gt; /etc/sysctl.conf
echo &quot;net.ipv4.tcp_congestion_control=bbr&quot; &gt;&gt; /etc/sysctl.conf
sysctl -p
lsmod | grep bbr
</pre></div>


<h3>3.&nbsp;安装shadowsocks-libev和simple-obfs混淆</h3>
<p>需要从stretch-backports库中安装，非Debian 9用户请参考<a href="https://github.com/shadowsocks/shadowsocks-libev#pre-build-configure-guide">文档</a></p>
<div class="highlight"><pre><span></span>sh -c <span class="s1">&#39;printf &quot;deb http://deb.debian.org/debian stretch-backports main&quot; &gt; /etc/apt/sources.list.d/stretch-backports.list&#39;</span>
apt update
apt -t stretch-backports install shadowsocks-libev simple-obfs
</pre></div>


<h3>4.&nbsp;优化TCP网络</h3>
<p>编辑sysctl文件，把下面的内容复制过去，&nbsp;如果第二步中没有开启bbr，那么请删除前两行。</p>
<p><code>vim /etc/sysctl.conf</code></p>
<div class="highlight"><pre><span></span><span class="na">net.core.default_qdisc</span> <span class="o">=</span> <span class="s">fq</span>
<span class="na">net.ipv4.tcp_congestion_control</span> <span class="o">=</span> <span class="s">bbr</span>
<span class="na">net.ipv4.tcp_fastopen</span> <span class="o">=</span> <span class="s">3</span>
<span class="na">fs.file-max</span> <span class="o">=</span> <span class="s">1024000</span>
<span class="na">net.core.rmem_max</span> <span class="o">=</span> <span class="s">67108864</span>
<span class="na">net.core.wmem_max</span> <span class="o">=</span> <span class="s">67108864</span>
<span class="na">net.core.rmem_default</span> <span class="o">=</span> <span class="s">65536</span>
<span class="na">net.core.wmem_default</span> <span class="o">=</span> <span class="s">65536</span>
<span class="na">net.core.netdev_max_backlog</span> <span class="o">=</span> <span class="s">4096</span>
<span class="na">net.core.somaxconn</span> <span class="o">=</span> <span class="s">4096</span>
<span class="na">net.ipv4.tcp_syncookies</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">net.ipv4.tcp_tw_reuse</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">net.ipv4.tcp_tw_recycle</span> <span class="o">=</span> <span class="s">0</span>
<span class="na">net.ipv4.tcp_fin_timeout</span> <span class="o">=</span> <span class="s">30</span>
<span class="na">net.ipv4.tcp_keepalive_time</span> <span class="o">=</span> <span class="s">1200</span>
<span class="na">net.ipv4.ip_local_port_range</span> <span class="o">=</span> <span class="s">10000 65000</span>
<span class="na">net.ipv4.tcp_max_syn_backlog</span> <span class="o">=</span> <span class="s">4096</span>
<span class="na">net.ipv4.tcp_max_tw_buckets</span> <span class="o">=</span> <span class="s">5000</span>
<span class="na">net.ipv4.tcp_rmem</span> <span class="o">=</span> <span class="s">4096 87380 67108864</span>
<span class="na">net.ipv4.tcp_wmem</span> <span class="o">=</span> <span class="s">4096 65536 67108864</span>
<span class="na">net.ipv4.tcp_mtu_probing</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">net.ipv4.ip_forward</span> <span class="o">=</span> <span class="s">1</span>
</pre></div>


<p>更改保存后执行</p>
<div class="highlight"><pre><span></span>sysctl -p
</pre></div>


<h3>5.&nbsp;配置服务端</h3>
<p><strong>修改配置</strong></p>
<p>编辑配置文件，填上自己的密码，端口建议使用443，别的端口封杀的太严重。
关于加密方式，现在新版都支持AEAD加密方式，详细内容请点<a href="https://shadowsocks.org/en/spec/AEAD-Ciphers.html">这里</a>。</p>
<p><code>vim /etc/shadowsocks-libev/config.json</code></p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_port&quot;</span><span class="p">:</span><span class="mi">443</span><span class="p">,</span>
    <span class="nt">&quot;local_port&quot;</span><span class="p">:</span><span class="mi">1080</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;chacha20-ietf-poly1305&quot;</span><span class="p">,</span>
    <span class="nt">&quot;mode&quot;</span><span class="p">:</span><span class="s2">&quot;tcp_and_udp&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fast_open&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;plugin&quot;</span><span class="p">:</span><span class="s2">&quot;obfs-server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;plugin_opts&quot;</span><span class="p">:</span><span class="s2">&quot;obfs=http;fast-open&quot;</span>
<span class="p">}</span>
</pre></div>


<p><strong>启动服务器端服务</strong></p>
<p>如果已经按照上面编辑好配置文件，那么就可以直接用文件模式启动服务。</p>
<div class="highlight"><pre><span></span>ss-server -c config.json <span class="c1">#测试模式</span>
systemctl start shadowsocks-libev <span class="c1">#后台启动</span>
systemctl <span class="nb">enable</span> shadowsocks-libev <span class="c1">#开机启动</span>
</pre></div>


<h3>6.&nbsp;配置客户端</h3>
<p><strong>Windows</strong></p>
<p>下载<a href="https://github.com/shadowsocks/shadowsocks-windows/releases">shadowsocks-windows</a>解压缩，
下载<a href="https://github.com/imgk/simple-obfs-Cygwin/releases">simple-obfs</a>中的obfs-local.exe和msys-2.0.dll放到shadowsocks-windows目录中,obfs-host随意写一个中国可以访问的网站。
<img alt="shadowsocks-windows" src="http://kevinstuchuang.qiniudn.com/blog-pic/shadowsocks-windows.png"></p>
<p><strong>Linux</strong></p>
<p>安装客户端和obfs</p>
<div class="highlight"><pre><span></span>sudo pacman -Syu
sudo pacman -S shadowsocks-libev simple-obfs
</pre></div>


<p>开启本地服务</p>
<div class="highlight"><pre><span></span>nohup ss-local -c config.json --plugin obfs-local --plugin-opts &quot;obfs=http;obfs-host=www.baidu.com;fast-open&quot;
</pre></div>


<p>开机启动，编辑启动文件&nbsp;，添加obfs混淆</p>
<p><code>vim /usr/lib/systemd/system/shadowsocks-libev@.service</code></p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Shadowsocks-Libev Client Service</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">CapabilityBoundingSet</span><span class="o">=</span><span class="s">CAP_NET_BIND_SERVICE</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/ss-local -c /etc/shadowsocks/%i.json --plugin obfs-local --plugin-opts &quot;obfs=http;obfs-host=www.baidu.com;fast-open&quot;</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>编辑配置文件
<code>vim /etc/shadowsocks/libev.json</code></p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="s2">&quot;你的服务器IP&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_port&quot;</span><span class="p">:</span><span class="mi">443</span><span class="p">,</span>
    <span class="nt">&quot;local_address&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;local_port&quot;</span><span class="p">:</span><span class="mi">65509</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;你的密码&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;chacha20-ietf-poly1305&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fast_open&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;workers&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;prefer_ipv6&quot;</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</pre></div>


<p>开启服务，@后面要和json文件同名</p>
<div class="highlight"><pre><span></span>sudo systemctl start shadowsocks-libev@libev
sudo systemctl <span class="nb">enable</span>  shadowsocks-libev@libev
</pre></div>


<p>其他内容请参考<a href="https://wiki.archlinux.org/index.php/Shadowsocks_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#.E5.91.BD.E4.BB.A4.E8.A1.8C">Archlinux Wiki</a>&nbsp;shadowsocks-qt5目前功能严重缺失，不建议使用，Linux平台最好是命令行模式</p>
<p><a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif?hl=zh-CN">SwitchyOmega</a>是目前Chome最好的代理插件，可以在<a href="https://www.switchyomega.com/download.html">官网</a>下载最新版本安装。</p>
<h3>7.Android客户端配置</h3>
<p>如果Android手机可以访问Google&nbsp;Play，则可以直接在上面搜shadowsocks和obfs分别安装后再配置即可。</p>
<p>如果当前手机不能访问Play，可以在github releases上分别下载<a href="https://github.com/shadowsocks/shadowsocks-android/releases">shadowsocks-android</a>和<a href="https://github.com/shadowsocks/simple-obfs-android/releases">simple-obfs-android</a>，安装后再配置自己的服务端信息。</p>
<h3>8.socks5转http/https</h3>
<p>实际使用中，经常会遇到命令行终端或本地程序需要代理，但是他们只支持http或https协议，所以就需要把socks5协议的代理转换协议，以Archlinux为例，方法也很简单。</p>
<p>安装privoxy</p>
<div class="highlight"><pre><span></span>sudo pacman -S privoxy
</pre></div>


<p>修改配置，找到如下两行打开注释，注意listen后的端口是未来我们要使用的端口，默认为8118，forward后的端口是shadowsocks使用的本地端口，这个依据自己的配置修改，不要忘了最后的&#8221;.&#8221;。
<code>sudo vim /etc/privoxy/config</code></p>
<div class="highlight"><pre><span></span>listen-address  <span class="m">127</span>.0.0.1:8118
forward-socks5t   /   <span class="m">127</span>.0.0.1:65509 .
</pre></div>


<p>保存配置后，启动或重启服务</p>
<div class="highlight"><pre><span></span>sudo systemctl start privoxy
sudo systemctl restart privoxy
</pre></div>


<p>以后需要使用时，修改两个本地变量即可</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="m">127</span>.0.0.1:8118
<span class="nb">echo</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="m">127</span>.0.0.1:8118
</pre></div>


<h3>9.&nbsp;服务器端常用的命令</h3>
<div class="highlight"><pre><span></span><span class="c1">#测试ss+obfs是否正常启动</span>
ss-server -c config.json --plugin obfs-server --plugin-opts <span class="s2">&quot;obfs=http&quot;</span>
<span class="c1">#查看obfs的进程编号</span>
ps ax<span class="p">|</span>grep obfs
<span class="c1">#查看ss的进程编号</span>
ps ax<span class="p">|</span>grep ss-server
<span class="c1">#查看ss监听端口</span>
netstat -nlp <span class="p">|</span>grep ss-server
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>链接</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>社交网站</h2>
                        <ul>

                            <li><a href="https://github.com/princelai">Github</a></li>
                            <li><a href="https://plus.google.com/100073068742779779797">G+</a></li>
                            <li><a href="https://twitter.com/princelai">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->
        <!--
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address>

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer>-->
    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1337838-7', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'solarck';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>