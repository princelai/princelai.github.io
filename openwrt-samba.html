<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>openwrt开启Samba作为共享中心</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Solarck  <strong>金融民工与程序猿的结合体</strong></a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/itbi-ji.html">IT笔记</a></li>
                    <li><a href="/category/jin-rong-bi-ji.html">金融笔记</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/openwrt-samba.html" rel="bookmark"
           title="Permalink to openwrt开启Samba作为共享中心">openwrt开启Samba作为共享中心</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-01-05T01:29:00+08:00">
                发布时间: 一月 05, 2014
        </abbr>

        <address class="vcard author">
                作者:                         <a class="url fn" href="/author/kevin-chen.html">Kevin Chen</a>
        </address>
<p>分类: <a href="/category/itbi-ji.html">IT笔记</a></p>
<p>标签: <a href="/tag/openwrt.html">openwrt</a> </p>
</footer><!-- /.post-info -->      <p>为Openwrt接入一个大U盘，不用来作共享中心的话实在没什么用处了，这也是为日后脱机BT下载提供一个基础。</p>
<h3>安装</h3>
<div class="highlight"><pre><span></span>opkg update
opkg install samba36-server luci-app-samba
</pre></div>


<!--more-->

<h4>配置文件</h4>
<p>samba的配置文件只有两个，而且默认配置稍作修改就可以使用</p>
<div class="highlight"><pre><span></span>root@openwrt:~# vi /etc/samba/smb.conf.template
<span class="o">[</span>global<span class="o">]</span>
    netbios <span class="nv">name</span> <span class="o">=</span> OpenWrt
    display <span class="nv">charset</span> <span class="o">=</span> UTF-8
    <span class="nv">interfaces</span> <span class="o">=</span> <span class="m">127</span>.0.0.1/8 lo <span class="m">192</span>.168.3.1/24 fd73:3a9a:156::1/60 br-lan <span class="c1">#内网IP</span>
    server <span class="nv">string</span> <span class="o">=</span> OpenWrt
    unix <span class="nv">charset</span> <span class="o">=</span> UTF-8
    <span class="nv">workgroup</span> <span class="o">=</span> WORKGROUP
    <span class="nv">browseable</span> <span class="o">=</span> yes
    <span class="nv">deadtime</span> <span class="o">=</span> <span class="m">30</span>
    domain <span class="nv">master</span> <span class="o">=</span> yes
    encrypt <span class="nv">passwords</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="nb">enable</span> core <span class="nv">files</span> <span class="o">=</span> no
    guest <span class="nv">account</span> <span class="o">=</span> nobody <span class="c1">#匿名用户</span>
    guest <span class="nv">ok</span> <span class="o">=</span> yes <span class="c1">#匿名用户</span>
    invalid <span class="nv">users</span> <span class="o">=</span> root
    <span class="nb">local</span> <span class="nv">master</span> <span class="o">=</span> yes
    load <span class="nv">printers</span> <span class="o">=</span> no
    map to <span class="nv">guest</span> <span class="o">=</span> Bad User
    max <span class="nv">protocol</span> <span class="o">=</span> SMB2
    min receivefile <span class="nv">size</span> <span class="o">=</span> <span class="m">16384</span>
    null <span class="nv">passwords</span> <span class="o">=</span> yes <span class="c1">#无需密码</span>
    obey pam <span class="nv">restrictions</span> <span class="o">=</span> yes
    os <span class="nv">level</span> <span class="o">=</span> <span class="m">20</span>
    passdb <span class="nv">backend</span> <span class="o">=</span> smbpasswd
    preferred <span class="nv">master</span> <span class="o">=</span> yes
    <span class="nv">printable</span> <span class="o">=</span> no
    <span class="nv">security</span> <span class="o">=</span> user
    smb <span class="nv">encrypt</span> <span class="o">=</span> disabled
    smb passwd <span class="nv">file</span> <span class="o">=</span> /etc/samba/smbpasswd
    socket <span class="nv">options</span> <span class="o">=</span> TCP_NODELAY IPTOS_LOWDELAY
    <span class="nv">syslog</span> <span class="o">=</span> <span class="m">2</span>
    use <span class="nv">sendfile</span> <span class="o">=</span> yes
    <span class="nv">writeable</span> <span class="o">=</span> yes <span class="c1">#可写</span>
</pre></div>


<div class="highlight"><pre><span></span>root@openwrt:~# vi /etc/config/samba
config samba
    option <span class="s1">&#39;name&#39;</span>           <span class="s1">&#39;OpenWrt&#39;</span>
    option <span class="s1">&#39;workgroup&#39;</span>      <span class="s1">&#39;WORKGROUP&#39;</span>
    option <span class="s1">&#39;description&#39;</span>        <span class="s1">&#39;OpenWrt&#39;</span>
    option <span class="s1">&#39;homes&#39;</span>          <span class="s1">&#39;1&#39;</span>

config <span class="s1">&#39;sambashare&#39;</span>
    option <span class="s1">&#39;name&#39;</span> <span class="s1">&#39;Shares&#39;</span>
    option <span class="s1">&#39;path&#39;</span> <span class="s1">&#39;/share&#39;</span> <span class="c1">#samba所在目录</span>
<span class="c1">#   option &#39;users&#39; &#39;sandra&#39;</span>
    option <span class="s1">&#39;guest_ok&#39;</span> <span class="s1">&#39;yes&#39;</span>
    option <span class="s1">&#39;create_mask&#39;</span> <span class="s1">&#39;0777&#39;</span> <span class="c1">#所有用户可写</span>
    option <span class="s1">&#39;dir_mask&#39;</span> <span class="s1">&#39;0777&#39;</span> <span class="c1">#所有用户可写</span>
    option <span class="s1">&#39;read_only&#39;</span> <span class="s1">&#39;no&#39;</span>
</pre></div>


<p>我的配置是无需密码所有用户都可以访问，可上传可下载。</p>
<p>配置完还需要对目录进行权限提升</p>
<div class="highlight"><pre><span></span>chmod a+w /share
</pre></div>


<p>或者更改文件夹用户</p>
<div class="highlight"><pre><span></span>chown nobody:nobody /share
</pre></div>


<p>最后重启samba服务并开机启动</p>
<div class="highlight"><pre><span></span>/etc/init.d/samba restart
/etc/init.d/samba <span class="nb">enable</span>
</pre></div>


<h3>访问</h3>
<p>Windows用户很容易访问，在网络邻居（网络）里就可以看到WORKGROUP&#8212;&gt;<span class="caps">OPENWRT</span>&#8212;&gt;Share文件夹了，但是linux用户需要一些其他命令。  <br>
<strong>1.&nbsp;安装g2sc</strong>    </p>
<div class="highlight"><pre><span></span>yaourt -S g2sc
</pre></div>


<p>安装完就可以像Windows一样看到工作组和文件夹，但是只能下载，没有上传功能。    </p>
<p><strong>2. sambclient</strong>&nbsp;安装工具</p>
<div class="highlight"><pre><span></span>yaourt -S sambaclient
</pre></div>


<p>连接主机    </p>
<div class="highlight"><pre><span></span>kevin@kevin:pts/2 ~$: smbclient -L OPENWRT
Enter kevins password:  <span class="c1">#没设密码直接回车</span>

    Sharename       Type      Comment
    ---------       ----      -------
    Shares          Disk      
    IPC$            IPC       IPC Service <span class="o">(</span>OpenWrt<span class="o">)</span>

    Server               Comment
    ---------            -------
    CHEN-PC              
    OPENWRT              OpenWrt

    Workgroup            Master
    ---------            -------
    WORKGROUP            OPENWRT
</pre></div>


<div class="highlight"><pre><span></span>kevin@kevin:pts/2 ~$: smbclient //OPENWRT/Shares <span class="c1">#格式为//Servername/Sharename</span>
smb: <span class="se">\&gt;</span>
</pre></div>


<p>出现了smb的命令行</p>
<div class="highlight"><pre><span></span>get ****    <span class="c1">#下载某个文件    </span>
put ****    <span class="c1">#上传某个文件</span>
</pre></div>


<p>更多命令输入?查看</p>
<p><strong>3.&nbsp;mount挂载</strong></p>
<div class="highlight"><pre><span></span>kevin@kevin:pts/2 ~$: mkdir /mnt/samba
kevin@kevin:pts/2 ~$: sudo mount -t cifs  -l //OPENWRT/Shares /mnt/samba
</pre></div>


<h3>完成</h3>
<p>由于安装了Luci，所以开启了uhttp服务，把共享目录链接到/www目录同样可以通过浏览器直接下载，相当于把Samba目录同样做成了FTP目录。</p>
<div class="highlight"><pre><span></span>kevin@kevin:pts/2 ~$: ln -s /share /www/share
</pre></div>


<p>Samba共享就全部完成，之后再继续研究BT下载，配合Samba的共享就等于免费拥有了一个简版NAS。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>链接</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>社交网站</h2>
                        <ul>

                            <li><a href="https://github.com/princelai">Github</a></li>
                            <li><a href="https://plus.google.com/100073068742779779797">G+</a></li>
                            <li><a href="https://twitter.com/princelai">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->
        <!--
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address>

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer>-->
    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1337838-7', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'solarck';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>